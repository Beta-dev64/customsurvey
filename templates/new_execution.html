{% extends 'base.html' %}

{% block title %}New Execution - Dangote POSM{% endblock %}

{% block head_extra %}
<style>
    .camera-box {
        width: 100%;
        height: 300px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
        background-color: #f8f9fa;
    }
    
    .camera-box video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .camera-box img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .camera-controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }
    
    .camera-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: {{ profile.primary_color }};
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
    }
    
    .camera-status {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .confirmation-img {
        max-height: 200px;
        object-fit: contain;
    }
    
    .btn-pulse {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 102, 0, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 102, 0, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 102, 0, 0);
        }
    }
    
    /* Mobile optimizations */
    @media (max-width: 767.98px) {
        .camera-box {
            height: 220px;
        }
        
        .confirmation-img {
            max-height: 150px;
        }
        
        .submit-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            width: 100%;
            padding: 10px;
            background-color: rgba(255,255,255,0.95);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }
        
        .execution-form-mobile-container {
            padding-bottom: 130px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast container for notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

<div class="container-fluid {% if request.user_agent.platform == 'iphone' or request.user_agent.platform == 'android' %}execution-form-mobile-container{% endif %}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">
            <span class="d-none d-md-inline">New Execution:</span> 
            {{ outlet.outlet_name }}
        </h1>
        <div>
            <a href="{{ url_for('outlets') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> <span class="d-none d-md-inline">Back</span>
            </a>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="executionForm">
        <!-- Outlet Information -->
        <div class="card mb-3">
            <div class="card-header bg-white py-2">
                <h5 class="card-title mb-0">Outlet Information</h5>
            </div>
            <div class="card-body p-2">
                <div class="accordion" id="outletAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#outletDetails">
                                Tap to view outlet details
                            </button>
                        </h2>
                        <div id="outletDetails" class="accordion-collapse collapse">
                            <div class="accordion-body p-2">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm outlet-info-table mb-0">
                                            <tr>
                                                <th>URN:</th>
                                                <td><small>{{ outlet.urn }}</small></td>
                                            </tr>
                                            <tr>
                                                <th>Customer:</th>
                                                <td>{{ outlet.customer_name }}</td>
                                            </tr>
                                            <tr>
                                                <th>Phone:</th>
                                                <td>{{ outlet.phone }}</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm outlet-info-table mb-0">
                                            <tr>
                                                <th>Address:</th>
                                                <td><small>{{ outlet.address }}</small></td>
                                            </tr>
                                            <tr>
                                                <th>Location:</th>
                                                <td>{{ outlet.state }}, {{ outlet.local_govt }}</td>
                                            </tr>
                                            <tr>
                                                <th>Type:</th>
                                                <td>{{ outlet.outlet_type }}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Capture -->
        <div class="card mb-3">
            <div class="card-header bg-white py-2">
                <h5 class="card-title mb-0">Image Capture</h5>
                <small class="text-muted">Images will be automatically compressed to reduce file size</small>
            </div>
            <div class="card-body p-3">
                <!-- Before Image -->
                <div class="mb-3">
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <strong>Before Image</strong>
                        <span class="badge bg-secondary" id="beforeStatus">Not Captured</span>
                    </div>
                    <div class="camera-box" id="beforeCameraBox">
                        <div class="camera-label">BEFORE</div>
                        <div class="text-center" id="beforePlaceholder">
                            <i class="fas fa-camera fa-3x mb-3 text-muted"></i>
                            <p class="small">Tap button below to capture image</p>
                        </div>
                        <video id="beforeVideo" autoplay playsinline style="display: none;"></video>
                        <img id="beforePreview" style="display: none;" />
                    </div>
                    
                    <div class="camera-controls">
                        <button type="button" class="btn btn-primary" id="beforeCaptureBtn">
                            <i class="fas fa-camera me-1"></i> <span class="d-none d-md-inline">Capture</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="beforeUploadBtn">
                            <i class="fas fa-upload me-1"></i> <span class="d-none d-md-inline">Upload</span>
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="beforeResetBtn" style="display: none;">
                            <i class="fas fa-times me-1"></i> <span class="d-none d-md-inline">Reset</span>
                        </button>
                    </div>
                    <input type="file" id="beforeFileInput" name="before_image" style="display: none;" accept="image/*" capture="environment">
                    <input type="hidden" id="beforeCapturedImage" name="before_captured_image">
                </div>
                
                <!-- After Image -->
                <div class="mb-3">
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <strong>After Image</strong>
                        <span class="badge bg-secondary" id="afterStatus">Not Captured</span>
                    </div>
                    <div class="camera-box" id="afterCameraBox">
                        <div class="camera-label">AFTER</div>
                        <div class="text-center" id="afterPlaceholder">
                            <i class="fas fa-camera fa-3x mb-3 text-muted"></i>
                            <p class="small">Tap button below to capture image</p>
                        </div>
                        <video id="afterVideo" autoplay playsinline style="display: none;"></video>
                        <img id="afterPreview" style="display: none;" />
                    </div>
                    
                    <div class="camera-controls">
                        <button type="button" class="btn btn-primary" id="afterCaptureBtn">
                            <i class="fas fa-camera me-1"></i> <span class="d-none d-md-inline">Capture</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="afterUploadBtn">
                            <i class="fas fa-upload me-1"></i> <span class="d-none d-md-inline">Upload</span>
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="afterResetBtn" style="display: none;">
                            <i class="fas fa-times me-1"></i> <span class="d-none d-md-inline">Reset</span>
                        </button>
                    </div>
                    <input type="file" id="afterFileInput" name="after_image" style="display: none;" accept="image/*" capture="environment">
                    <input type="hidden" id="afterCapturedImage" name="after_captured_image">
                </div>
            </div>
        </div>

        <!-- Geolocation -->
        <div class="card mb-3">
            <div class="card-header bg-white py-2">
                <h5 class="card-title mb-0">Geolocation</h5>
            </div>
            <div class="card-body p-3">
                <div class="geolocation-box" id="geolocationStatus">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status" style="width: 1.5rem; height: 1.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <strong>Detecting location...</strong>
                            <p class="mb-0 small text-muted">Please allow location access</p>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
            </div>
        </div>

        <!-- Product Availability -->
        <div class="card mb-3">
            <div class="card-header bg-white py-2">
                <h5 class="card-title mb-0">POSM Deployed <span style="color: red; font-size: smaller;">(Please tick below for deployed POSM)</span></h5>
            </div>
            <div class="card-body p-3">
                <div class="row g-2">
                    {% for product in products %}
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="form-check">
                                    <input class="form-check-input posm-checkbox" type="checkbox" value="Yes" id="product_{{ product|replace(' ', '_') }}" name="product_{{ product|replace(' ', '_') }}">
                                    <label class="form-check-label" for="product_{{ product|replace(' ', '_') }}">
                                        {{ product }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div id="posmValidationMessage" class="text-danger mt-2" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i> Please select at least one POSM item that was deployed
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="card mb-3">
            <div class="card-header bg-white py-2">
                <h5 class="card-title mb-0">Notes</h5>
            </div>
            <div class="card-body p-3">
                <div class="form-group">
                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add notes or observations"></textarea>
                </div>
            </div>
        </div>

        <!-- Submit Button - Regular version for desktop -->
        <div class="card mb-4 d-none d-md-block">
            <div class="card-body">
                <div class="d-grid">
                    <button type="submit" class="btn btn-secondary btn-lg" id="submitBtn" disabled>
                        <i class="fas fa-save me-1"></i> Submit Execution
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Fixed Submit Button for Mobile -->
        <div class="submit-container d-md-none">
            <div class="d-grid">
                <button type="submit" class="btn btn-secondary btn-lg" id="mobileSubmitBtn" disabled>
                    <i class="fas fa-save me-1"></i> Submit Execution
                </button>
            </div>
        </div>
    </form>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Execution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Please confirm the images to be submitted:</p>
                    
                    <div class="row">
                        <div class="col-md-6 text-center mb-3">
                            <h6>Before Image</h6>
                            <img id="confirmBeforeImage" class="img-fluid confirmation-img border rounded mb-2" alt="Before Image">
                            <p class="small" id="beforeImageSize"></p>
                        </div>
                        <div class="col-md-6 text-center mb-3">
                            <h6>After Image</h6>
                            <img id="confirmAfterImage" class="img-fluid confirmation-img border rounded mb-2" alt="After Image">
                            <p class="small" id="afterImageSize"></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i> Please verify that the images clearly show the outlet before and after execution.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit Images</button>
                    <button type="button" class="btn btn-primary" id="confirmSubmitBtn">Confirm & Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Camera Sound -->
    <audio id="cameraSound" src="https://www.soundjay.com/mechanical/sounds/camera-shutter-click-01.mp3" preload="auto"></audio>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
<script>
    // Function to compress image
    async function compressImage(file, quality = 0.7, maxWidth = 1024, maxHeight = 1024) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Calculate new dimensions while maintaining aspect ratio
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                    
                    // Create canvas and draw image
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to compressed JPEG
                    canvas.toBlob((blob) => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, 'image/jpeg', quality);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // Function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Initialize geolocation
    document.addEventListener('DOMContentLoaded', function() {
        // Get geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    document.getElementById('latitude').value = latitude;
                    document.getElementById('longitude').value = longitude;
                    
                    document.getElementById('geolocationStatus').innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="bg-success text-white rounded-circle me-3" style="width: 30px; height: 30px; display: flex; justify-content: center; align-items: center;">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <strong>Location detected</strong>
                                <p class="mb-0 small">Lat: ${latitude.toFixed(6)}, Long: ${longitude.toFixed(6)}</p>
                            </div>
                        </div>
                    `;
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    document.getElementById('geolocationStatus').innerHTML = `
                        <div class="alert alert-danger mb-0 p-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Location detection failed</strong>
                            <p class="mb-0 small">Please enable location services</p>
                        </div>
                    `;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            document.getElementById('geolocationStatus').innerHTML = `
                <div class="alert alert-danger mb-0 p-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Geolocation not supported</strong>
                    <p class="mb-0 small">Your browser doesn't support location</p>
                </div>
            `;
        }

        // Handle file uploads with compression
        async function handleFileUpload(fileInput, previewElement, hiddenInput, statusElement) {
            const file = fileInput.files[0];
            if (!file) return;
            
            try {
                // Show loading state
                statusElement.textContent = 'Compressing...';
                statusElement.className = 'badge bg-warning';
                
                // Compress the image
                const compressedFile = await compressImage(file);
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewElement.src = e.target.result;
                    previewElement.style.display = 'block';
                    hiddenInput.value = e.target.result;
                    
                    // Update status
                    statusElement.textContent = 'Captured';
                    statusElement.className = 'badge bg-success';
                    
                    // Check form validity
                    checkFormValidity();
                };
                reader.readAsDataURL(compressedFile);
                
                // Replace the original file with the compressed one
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(compressedFile);
                fileInput.files = dataTransfer.files;
                
                return compressedFile;
            } catch (error) {
                console.error('Error compressing image:', error);
                statusElement.textContent = 'Error';
                statusElement.className = 'badge bg-danger';
                return null;
            }
        }

        // Set up file input event listeners for both before and after images
        const beforeFileInput = document.getElementById('beforeFileInput');
        const beforePreview = document.getElementById('beforePreview');
        const beforeHiddenInput = document.getElementById('beforeCapturedImage');
        const beforeStatus = document.getElementById('beforeStatus');
        
        const afterFileInput = document.getElementById('afterFileInput');
        const afterPreview = document.getElementById('afterPreview');
        const afterHiddenInput = document.getElementById('afterCapturedImage');
        const afterStatus = document.getElementById('afterStatus');
        
        beforeFileInput.addEventListener('change', async function() {
            const compressedFile = await handleFileUpload(beforeFileInput, beforePreview, beforeHiddenInput, beforeStatus);
            if (compressedFile) {
                document.getElementById('beforePlaceholder').style.display = 'none';
                document.getElementById('beforeResetBtn').style.display = 'inline-block';
            }
        });
        



        
        afterFileInput.addEventListener('change', async function() {
            const compressedFile = await handleFileUpload(afterFileInput, afterPreview, afterHiddenInput, afterStatus);
            if (compressedFile) {
                document.getElementById('afterPlaceholder').style.display = 'none';
                document.getElementById('afterResetBtn').style.display = 'inline-block';
            }
        });


        // Update confirmation modal with compressed images
        // Modify the camera capture handler in camera.js
        async function captureImage(videoElement, previewElement, hiddenInput, statusElement) {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to Blob and compress
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
            const compressedFile = await compressImage(new File([blob], 'captured.jpg'));
            
            // Convert compressed file to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                previewElement.src = e.target.result;
                hiddenInput.value = e.target.result; // Store base64 string
                statusElement.textContent = 'Captured';
                statusElement.className = 'badge bg-success';
                checkFormValidity();
            };
            reader.readAsDataURL(compressedFile);
            
            // Hide video and show preview
            videoElement.style.display = 'none';
            previewElement.style.display = 'block';
        }

        // Update the form submission handler to remove redundant compression
        document.getElementById('executionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const mobileSubmitBtn = document.getElementById('mobileSubmitBtn');
            const originalSubmitText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
            submitBtn.disabled = true;
            mobileSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
            mobileSubmitBtn.disabled = true;
            
            try {
                // Get the before image
                let beforeImageSrc = '';
                if (beforeFileInput.files.length > 0) {
                    const compressedFile = await compressImage(beforeFileInput.files[0]);
                    beforeImageSrc = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(compressedFile);
                    });
                } else if (beforeHiddenInput.value) {
                    // const compressedFile = await compressImage(beforeHiddenInput.value);
                    // beforeImageSrc = await new Promise((resolve) => {
                    //     const reader = new FileReader();
                    //     reader.onload = (e) => resolve(e.target.result);
                    //     reader.readAsDataURL(compressedFile);
                    // });
                    beforeImageSrc = beforeHiddenInput.value;
                }
                
                // Get the after image
                let afterImageSrc = '';
                if (afterFileInput.files.length > 0) {
                    const compressedFile = await compressImage(afterFileInput.files[0]);
                    afterImageSrc = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(compressedFile);
                    });
                } else if (afterHiddenInput.value) {
                    // const compressedFile = await compressImage(afterHiddenInput.value);
                    // afterImageSrc = await new Promise((resolve) => {
                    //     const reader = new FileReader();
                    //     reader.onload = (e) => resolve(e.target.result);
                    //     reader.readAsDataURL(compressedFile);
                    // });
                    afterImageSrc = afterHiddenInput.value;
                }
                
                // Update confirmation modal
                document.getElementById('confirmBeforeImage').src = beforeImageSrc;
                document.getElementById('confirmAfterImage').src = afterImageSrc;
                
                // Calculate and display file sizes
                if (beforeImageSrc) {
                    const beforeSize = Math.round((beforeImageSrc.length * 3) / 4); // Approximate size from base64
                    document.getElementById('beforeImageSize').textContent = `Size: ${formatFileSize(beforeSize)}`;
                }
                
                if (afterImageSrc) {
                    const afterSize = Math.round((afterImageSrc.length * 3) / 4); // Approximate size from base64
                    document.getElementById('afterImageSize').textContent = `Size: ${formatFileSize(afterSize)}`;
                }
                
                // Show modal
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                confirmModal.show();
                
                // Reset button states
                submitBtn.innerHTML = originalSubmitText;
                mobileSubmitBtn.innerHTML = originalSubmitText;
                submitBtn.disabled = false;
                mobileSubmitBtn.disabled = false;
            } catch (error) {
                console.error('Error preparing confirmation:', error);
                submitBtn.innerHTML = originalSubmitText;
                mobileSubmitBtn.innerHTML = originalSubmitText;
                submitBtn.disabled = false;
                mobileSubmitBtn.disabled = false;
                
                // Show error toast
                showToast('Error preparing images for submission', 'danger');
            }
        });
        
        // Handle final submission from confirmation modal
        document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
            document.getElementById('executionForm').submit();
            // const whale = document.getElementById('executionForm')
            // console.log("whale: ", whale);
        });

        const posmCheckboxes = document.querySelectorAll('.posm-checkbox');
        const posmValidationMessage = document.getElementById('posmValidationMessage');
        const submitBtn = document.getElementById('submitBtn');
        const mobileSubmitBtn = document.getElementById('mobileSubmitBtn');
        
        // Function to check if at least one POSM is selected
        function validatePosmSelection() {
            let atLeastOneChecked = false;
            posmCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    atLeastOneChecked = true;
                }
            });
            
            if (!atLeastOneChecked) {
                posmValidationMessage.style.display = 'block';
                return false;
            } else {
                posmValidationMessage.style.display = 'none';
                return true;
            }
        }
        
        // Add event listeners to all POSM checkboxes
        posmCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                validatePosmSelection();
                checkFormValidity();
            });
        });
        
        // Function to check overall form validity
        function checkFormValidity() {
            const beforeImageValid = document.getElementById('beforeCapturedImage').value !== '' || 
                                    document.getElementById('beforeFileInput').files.length > 0;
            const afterImageValid = document.getElementById('afterCapturedImage').value !== '' || 
                                   document.getElementById('afterFileInput').files.length > 0;
            const posmValid = validatePosmSelection();
            const locationValid = document.getElementById('latitude').value !== '' && 
                                 document.getElementById('longitude').value !== '';
            
            // Enable submit buttons only if all validations pass
            if (beforeImageValid && afterImageValid && posmValid && locationValid) {
                submitBtn.disabled = false;
                mobileSubmitBtn.disabled = false;
                submitBtn.classList.add('btn-primary');
                submitBtn.classList.remove('btn-secondary');
                mobileSubmitBtn.classList.add('btn-primary');
                mobileSubmitBtn.classList.remove('btn-secondary');
            } else {
                submitBtn.disabled = true;
                mobileSubmitBtn.disabled = true;
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-secondary');
                mobileSubmitBtn.classList.remove('btn-primary');
                mobileSubmitBtn.classList.add('btn-secondary');
            }
        }
        
        // Form submission validation
        document.getElementById('executionForm').addEventListener('submit', function(event) {
            if (!validatePosmSelection()) {
                event.preventDefault();
                // Scroll to the POSM section
                document.querySelector('.posm-checkbox').closest('.card').scrollIntoView({ behavior: 'smooth' });
            }
        });
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toastEl.remove();
            }, 5000);
        }

        // Initial form validation check
        validatePosmSelection();
    });
</script>
{% endblock %}
