{% extends 'admin/base_admin.html' %}

{% block title %}Execution Management - Dangote Cement{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="admin-title mb-0">Execution Management</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="fas fa-upload me-1"></i> Upload File
    </button>
</div>

<!-- File Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Execution File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="uploadStep" class="upload-step">
                    <div class="mb-3">
                        <label for="executionFile" class="form-label">Select File</label>
                        <input type="file" class="form-control" id="executionFile" accept=".csv,.xlsx,.xls" required>
                        <div class="form-text">Supported formats: .csv, .xlsx, .xls. Required columns: URN, Outlet Name. Optional: Date, Status, Notes, Table, Chair, Parasol, Tarpaulin, Hawker Jacket</div>
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" id="importBtn" disabled>
                            <i class="fas fa-upload me-1"></i> Import Data
                        </button>
                    </div>
                </div>
                
                <div id="resultStep" class="upload-step" style="display: none;">
                    <div id="importResults"></div>
                    <div class="d-grid mt-3">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card admin-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Executions</h5>
        <div class="input-group" style="width: 300px">
            <input type="text" class="form-control form-control-sm" id="executionSearch" placeholder="Search executions...">
            <button class="btn btn-sm btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover admin-table mb-0" id="executionTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date & Time</th>
                        <th>Outlet</th>
                        <th>Region</th>
                        <th>State</th>
                        <th>Agent</th>
                        <th>Status</th>
                        <th style="width: 120px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for execution in executions %}
                    <tr>
                        <td>{{ execution.id }}</td>
                        <td>{{ execution.execution_date }}</td>
                        <td>{{ execution.outlet_name }}</td>
                        <td>{{ execution.region }}</td>
                        <td>{{ execution.state }}</td>
                        <td>{{ execution.agent_name }}</td>
                        <td>
                            {% if execution.status == 'Completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% elif execution.status == 'Pending' %}
                                <span class="badge bg-warning">Pending</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ execution.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('execution_detail', execution_id=execution.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    data-bs-toggle="modal" data-bs-target="#deleteModal{{ execution.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="modal fade" id="deleteModal{{ execution.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Confirm Deletion</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete this execution record?</p>
                                            <p>This will permanently delete all associated images and data.</p>
                                            <p class="text-danger">This action cannot be undone.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <form action="{{ url_for('admin.execution_delete', execution_id=execution.id) }}" method="post">
                                                <button type="submit" class="btn btn-danger">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-3">No executions found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card admin-card mt-4">
    <div class="card-header">
        <h5 class="card-title">Advanced Filters</h5>
    </div>
    <div class="card-body">
        <form class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <select class="form-select" id="dateFilter">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Region</label>
                <select class="form-select" id="regionFilter">
                    <option value="all">All Regions</option>
                    <option value="SW">South West</option>
                    <option value="SE">South East</option>
                    <option value="NC">North Central</option>
                    <option value="NW">North West</option>
                    <option value="NE">North East</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Agent</label>
                <select class="form-select" id="agentFilter">
                    <option value="all">All Agents</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="all">All Statuses</option>
                    <option value="Completed">Completed</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            <div class="col-12 mt-4">
                <button type="button" class="btn btn-primary" id="applyFilters">
                    <i class="fas fa-filter me-1"></i> Apply Filters
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetFilters">
                    <i class="fas fa-undo me-1"></i> Reset Filters
                </button>
                <button type="button" class="btn btn-outline-success" id="exportData">
                    <i class="fas fa-file-export me-1"></i> Export Data
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let fileData = null;
    
    // File input change handler
    document.getElementById('executionFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const importBtn = document.getElementById('importBtn');
        
        if (file && (file.type === 'text/csv' || file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
            importBtn.disabled = false;
            fileData = file;
        } else {
            importBtn.disabled = true;
            if (file) {
                alert('Please select a valid CSV or Excel file (.csv, .xlsx, .xls).');
            }
        }
    });
    
    // Import button handler
    document.getElementById('importBtn').addEventListener('click', function() {
        if (!fileData) {
            alert('Please select a file to import.');
            return;
        }
        
        importData();
    });
    
    // Import data function
    function importData() {
        const importBtn = document.getElementById('importBtn');
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Importing...';
        
        const formData = new FormData();
        formData.append('file', fileData);
        
        fetch('{{ url_for("admin.execution_upload") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            // Parse flash messages from the response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const messages = Array.from(doc.querySelectorAll('.alert')).map(alert => ({
                type: alert.classList.contains('alert-success') ? 'success' : 
                      alert.classList.contains('alert-danger') ? 'danger' : 'warning',
                message: alert.textContent.trim()
            }));
            
            displayImportResults(messages);
            showStep('resultStep');
            
            if (messages.some(msg => msg.type === 'success')) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayImportResults([{
                type: 'danger',
                message: 'An error occurred during import. Please try again.'
            }]);
            showStep('resultStep');
        })
        .finally(() => {
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-upload me-1"></i> Import Data';
        });
    }
    
    // Display import results
    function displayImportResults(messages) {
        const resultsDiv = document.getElementById('importResults');
        resultsDiv.innerHTML = messages.map(msg => `
            <div class="alert alert-${msg.type}">
                <i class="fas fa-${msg.type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-1"></i>
                ${msg.message}
            </div>
        `).join('');
    }
    
    // Show step function
    function showStep(stepId) {
        document.querySelectorAll('.upload-step').forEach(step => {
            step.style.display = 'none';
        });
        document.getElementById(stepId).style.display = 'block';
    }
    
    // Reset modal when closed
    document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
        showStep('uploadStep');
        document.getElementById('executionFile').value = '';
        document.getElementById('importBtn').disabled = true;
        fileData = null;
    });
    
    // Existing search and filter functionality
    const searchInput = document.getElementById('executionSearch');
    const table = document.getElementById('executionTable');
    const rows = table.querySelectorAll('tbody tr');
    
    searchInput.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
    
    document.getElementById('applyFilters').addEventListener('click', function() {
        alert('In a real implementation, this would filter the executions based on your criteria.');
    });
    
    document.getElementById('resetFilters').addEventListener('click', function() {
        document.getElementById('dateFilter').value = 'month';
        document.getElementById('regionFilter').value = 'all';
        document.getElementById('agentFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        alert('Filters have been reset.');
    });
    
    document.getElementById('exportData').addEventListener('click', function() {
        const table = document.getElementById('executionTable');
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        headers.pop(); // Remove Actions column
        
        const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => 
            row.style.display !== 'none' && !row.classList.contains('no-results')
        );
        
        const data = visibleRows.map(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            cells.pop(); // Remove Actions cell
            return cells.map(cell => {
                const badge = cell.querySelector('.badge');
                return badge ? badge.textContent.trim() : cell.textContent.trim();
            });
        });
        
        let csvContent = headers.join(',') + '\n';
        data.forEach(row => {
            csvContent += row.join(',') + '\n';
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `executions_export_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>
{% endblock %}